/*
* jQuery Validator Plugin
*
* @copyright	2013 Rain Lee <raincious@gmail.com>
* @author		Rain Lee <raincious@gmail.com>
* @package		jQuery.validator
* @version		0.0 prototype
*
* Copyright (c) 2013, Rain Lee
* All rights reserved.
*
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions are met:
*
* 1. Redistributions of source code must retain the above copyright notice, this
*    list of conditions and the following disclaimer.
* 2. Redistributions in binary form must reproduce the above copyright notice,
*    this list of conditions and the following disclaimer in the documentation
*    and/or other materials provided with the distribution.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
* ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
* WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
* DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
* ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
* (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
* LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*
* The views and conclusions contained in the software and documentation are those
* of the authors and should not be interpreted as representing official policies,
* either expressed or implied, of the FreeBSD Project.
*
*/

(function(e){var t=function(t,n){var r=false;var i=this;i.onSubmit=function(e){};i.onWait=i.onPassed=i.onError=function(e){};i.data={lastErrPos:{}};var s={formats:null,inputs:[],binds:{},methods:{length:function(e,t,n){if((!t||e.length<=t)&&(!n||e.length>=n)){return true}},compare:function(e,t,n){if((!t||e<=t)&&(!n||e>=n)){return true}},equal:function(t,n){if(t==e(n).val()){return true}}},events:{Wait:i.onWait,Passed:i.onPassed,Errored:i.onError}};var o={WAIT:1,PASSED:2,INVALID:3,VERIFY:4,GET:5,TEST:6};var u=function(){if(r){f("Inited, cannot reinit");return false}if(typeof t==="undefined"){f("Form must be specified");return false}if(!t.is("form")){f("Target not a form");return false}if(typeof n==="undefined"){f("Option must be defined");return false}if(typeof n.Format==="undefined"){f("Format not set");return false}else{s.formats=n.Format;for(var u in n.Format){s.formats[u]=a(n.Format[u])}}if(typeof n.Events==="object"){for(var u in n.Events){if(typeof n.Events[u]==="function"){s.events[u]=n.Events[u]}else{f("Event "+u+" not a closure, ignoring")}}}if(typeof n.Methods==="object"){for(var u in n.Methods){if(typeof n.Methods[u]==="function"){s.methods[u]=n.Methods[u]}else{f("Method "+u+" not a closure, ignoring")}}}if(typeof n.Binds==="object"){for(var u in n.Binds){if(typeof n.Binds[u]==="function"){s.binds[u]=n.Binds[u]}else{f("Bind "+u+" not a closure");return false}}}t.find("input,textarea,select,button").each(function(){var t=e(this);var n=function(){},r=function(){},i=function(){},u=function(){},a=function(e){},f=function(){},l=function(){};var h={Max:t.data("validator-maxlength")||t.data("va-max")||0,Min:t.data("validator-minlength")||t.data("va-min")||0,Type:t.data("validator-type")||t.data("va-type")||"",Method:t.data("validator-method")||t.data("va-method")||"length",Resulter:t.data("validator-resulter")||t.data("va-show")||"",WrongCSS:t.data("validator-wrong")||t.data("va-error")||"",WorkingCSS:t.data("validator-working")||t.data("va-working")||"",msgResulter:t.data("validator-messager")||t.data("va-msgr")||"",WrongMSG:t.data("validator-message")||t.data("va-msg")||"",hook:function(e,t){return o.PASSED},setWrong:function(){},dismissWrong:function(){},setWorking:function(){},dismissWorking:function(){},validated:function(e){}};if(h.Resulter){h.ResulterObj=e(h.Resulter)}if(h.msgResulter){h.msgResulterObj=e(h.msgResulter)}if(typeof h.ResulterObj==="object"){n=function(){h.ResulterObj.addClass(h.WrongCSS)};r=function(){h.ResulterObj.removeClass(h.WrongCSS)};i=function(){h.ResulterObj.addClass(h.WorkingCSS)};u=function(){h.ResulterObj.removeClass(h.WorkingCSS)}}if(typeof h.msgResulterObj==="object"){var p=h.msgResulterObj.text();a=function(e){if(e){h.msgResulterObj.text(e)}else{h.msgResulterObj.text(p)}};f=function(){a(h.WrongMSG.replace("{max}",h.Max).replace("{min}",h.Min))};l=function(){h.msgResulterObj.text(p)}}for(var d in s.binds){if(t.is(e(d))){h.hook=s.binds[d];break}}t.message=a;t.validate=function(e){switch(e){case o.GET:var a=t["validated"];if(typeof a==="undefined"){return t.validate(o.VERIFY)}return a;break;case o.VERIFY:if(c(t.val(),h.Max,h.Min,h.Type,h.Method)){return t.validate(o.PASSED)}else{return t.validate(o.INVALID)}break;case o.TEST:if(c(t.val(),h.Max,h.Min,h.Type,h.Method)){return o.PASSED}else{return o.INVALID}break;default:switch(e){case o.WAIT:i();s.events.Wait(t);break;case o.PASSED:r();l();u();s.events.Passed(t);break;case o.INVALID:n();f();u();s.events.Errored(t);break}t["validated"]=e;return e;break}};var v=function(){t.validate(o.WAIT);return h.hook(t,function(e){if(e){if(t.validate(o.TEST)==o.PASSED){t.validate(o.PASSED);return true}else{t.validate(o.INVALID)}}else{t.validate(o.INVALID)}})};var m=function(){if(t.validate(o.VERIFY)==o.PASSED){switch(v()){case o.PASSED:return t.validate(o.PASSED);case o.INVALID:return t.validate(o.PASSED)}}};var g=function(){if(t["validate-tested"]!==true&&t.validate(o.TEST)==o.PASSED){t["validate-tested"]=true;return o.WAIT}if(t["validate-tested"]===true){return m()}};t.change(m);t.keyup(g);t.validator=h;s.inputs.push(t)});t.submit(function(){if(l()){i.onSubmit(true);return true}else{i.onSubmit(false)}return false});r=true;return true};var a=function(e){return e.replace(/\{/g,"").replace(/\}/g,"").replace(/\\x/g,"\\u").match("/(.*)/")[1]};var f=function(e){if(typeof console!=undefined){console.log("[Validator] validator stopped due to a problem: "+e+".")}};var l=function(){var e=true;for(var t in s.inputs){if(s.inputs[t].validate(o.GET)!=o.PASSED){if(e){i.data.lastErrPos=s.inputs[t].offset()}e=false}}if(e){i.data.lastErrPos={}}return e};var c=function(e,t,n,r,i){if(!e){if(!n){return true}else{return false}}if(r&&typeof s.formats[r]!=="undefined"&&!e.match(s.formats[r])){return false}if(typeof s.methods[i]==="function"){if(!s.methods[i](e,t,n)){return false}return true}else{f("Method "+i+" not found.")}};u()};e.fn.validator=function(n,r){var i={};if(typeof r!=="undefined"){i={topOffset:typeof r.topOffset!=="undefined"?r.topOffset:50}}else{i={topOffset:50}}var s=new t(this,n);s.onSubmit=function(t){if(!t&&typeof s.data.lastErrPos.top!=="undefined"){e("html, body").animate({scrollTop:s.data.lastErrPos.top-i.topOffset},1e3)}};return s}})(jQuery)
